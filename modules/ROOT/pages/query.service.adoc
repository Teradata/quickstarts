= Query Service Quick Start Guide
:experimental:
:page-author: Sudha vedula
:page-email: sudha.vedula@teradata.com
:page-revdate: October 27th, 2022
:description: TeradataÂ® Query Service is a middleware that provides REST APIs for relational Databases, including Teradata Database, Aster, and Hive.
:keywords: query service, teradata, vantage, query,

== Overview

Query Service provides APIs to:

.   Configure Teradata-supported systems
.	Submit SQL queries and access responses
.	Create database sessions
.	Access database and object metadata

This quickstart guide provides you examples for invoking REST API's using cURL.

== Prerequisites

Before you start, make sure:

.	Query Service is installed and configured . See link:https://docs.teradata.com/r/Teradata-Query-Service-Installation-Configuration-and-Usage-Guide-for-Customers/April-2022[Query Service ICU Guide]
.	The required authorization to connect to Database.

== Query Service API Examples

==== Connecting to your query service instance

----
import requests
import json
import base64
requests.packages.urllib3.disable_warnings()

# run it from local.

db_user, db_password = "dbc","dbc"
auth_encoded = db_user +":" + db_password
auth_encoded = base64.b64encode(bytes(auth_encoded, 'utf-8'))
auth_str = "Basic " + auth_encoded.decode("utf-8")

print(auth_str)


headers = {
  'Content-Type': 'application/json',
  'Authorization': auth_str # base 64 encoded username:password
}

print(headers)
----

Response
----
Basic ZGJjOmRiYw==
{'Content-Type': 'application/json', 'Authorization': 'Basic ZGJjOmRiYw=='}
----

==== Running query - Getting a JSON response with minimal set of options

----
url = "https://sdl57120:1443/systems/testsystem/queries"

payload = {

"query":"SELECT * FROM DBC.DBCInfo;",
"format":"OBJECT"

}

payload_json = json.dumps(payload)
response = requests.request("POST", url, headers=headers, data=payload_json, verify=False)

print(response.text)

----
Response
----
{"queueDuration":260,"queryDuration":29,"results":[{"resultSet":true,"data":[{"InfoKey":"LANGUAGE SUPPORT MODE","InfoData":"Standard"},{"InfoKey":"RELEASE","InfoData":"15.10.07.02"},{"InfoKey":"VERSION","InfoData":"15.10.07.02"}],"rowCount":3,"rowLimitExceeded":false}]}
----

==== Running a query - Adding column names and types to response

----
url = "https://sdl57120:1443/systems/testsystem/queries"

payload = {

"query":"SELECT * FROM DBC.DBCInfo;",
"format":"OBJECT" ,
"includeColumns":True, # false by default

}

payload_json = json.dumps(payload)
response = requests.request("POST", url, headers=headers, data=payload_json, verify=False)

print(response.text)
----
Response
----
{"queueDuration":4,"queryDuration":27,"results":[{"resultSet":true,"columns":[{"name":"InfoKey","type":"VARCHAR"},{"name":"InfoData","type":"VARCHAR"}],"data":[{"InfoKey":"LANGUAGE SUPPORT MODE","InfoData":"Standard"},{"InfoKey":"RELEASE","InfoData":"15.10.07.02"},{"InfoKey":"VERSION","InfoData":"15.10.07.02"}],"rowCount":3,"rowLimitExceeded":false}]}
----
==== Run a query - Get CSV response

----
## get CSV response
example_query = """SELECT
DatabaseName
,SUM(CurrentPerm)/1024/1024/1024 AS USEDSPACE_IN_GB
,SUM(MaxPerm)/1024/1024/1024 AS MAXSPACE_IN_GB
,SUM(CurrentPerm)/ NULLIFZERO (SUM(MaxPerm)) *100 (FORMAT 'zz9.99%') AS Percentage_Used
,MAXSPACE_IN_GB- USEDSPACE_IN_GB AS REMAININGSPACE_IN_GB
FROM DBC.DiskSpace
--WHERE DatabaseName = 'PUBLIC'
order by 3 desc
GROUP BY DatabaseName;
"""
----
----
# CSV with all rows included

url = "https://sdl57120:1443/systems/testsystem/queries"

payload = {
"query":example_query, # "SELECT * FROM DBC.DBCInfo;",
"format":"CSV", "includeColumns":True,

}

payload_json = json.dumps(payload)

response = requests.request("POST", url, headers=headers, data=payload_json, verify=False)


print(response.text)

----
Response
----
DatabaseName,USEDSPACE_IN_GB,MAXSPACE_IN_GB,Percentage_Used,REMAININGSPACE_IN_GB
DBC                           ,317.7634754180908,1510.521079641879,21.036679308932754,1192.7576042237881
EM                            ,7.491111755371094E-4,11.546071618795395,0.006488017745513208,11.545322507619858
user10                        ,0.019153594970703125,9.313225746154785,0.20566016,9.294072151184082
EMEM                          ,0.006140708923339844,4.656612873077393,0.13187072,4.650472164154053
EMWork                        ,0.0,4.656612873077393,0.0,4.656612873077393
EMJI                          ,0.0,2.3283064365386963,0.0,2.3283064365386963
USER_NAME                     ,0.0,2.0,0.0,2.0
readonly                      ,0.0,0.9313225746154785,0.0,0.9313225746154785
aug12_db                      ,7.200241088867188E-5,0.9313225746154785,0.0077312,0.9312505722045898
SystemFe                      ,1.8024444580078125E-4,0.7450580596923828,0.024192,0.744877815246582
dbcmngr                       ,3.814697265625E-6,0.09313225746154785,0.004096,0.09312844276428223
EMViews                       ,0.027594566345214844,0.09313225746154785,29.62944,0.06553769111633301
tdwm                          ,6.732940673828125E-4,0.09313225746154785,0.722944,0.09245896339416504
Crashdumps                    ,0.0,0.06984921544790268,0.0,0.06984921544790268
SYSLIB                        ,0.006252288818359375,0.03725290298461914,16.78336,0.031000614166259766
SYSBAR                        ,4.76837158203125E-6,0.03725290298461914,0.0128,0.03724813461303711
SYSUDTLIB                     ,3.5381317138671875E-4,0.029802322387695312,1.1872,0.029448509216308594
External_AP                   ,0.0,0.01862645149230957,0.0,0.01862645149230957
SysAdmin                      ,0.002307891845703125,0.01862645149230957,12.3904,0.016318559646606445
KZXaDtQp                      ,0.0,0.009313225746154785,0.0,0.009313225746154785
s476QJ6O                      ,0.0,0.009313225746154785,0.0,0.009313225746154785
hTzz03i7                      ,0.0,0.009313225746154785,0.0,0.009313225746154785
Y5WYUUXj                      ,0.0,0.009313225746154785,0.0,0.009313225746154785
----
==== Run query - Limit the number of rows in the response
----
# Get Json response with row limits

url = "https://sdl57120:1443/systems/testsystem/queries"

payload = {
"query":example_query, # "SELECT * FROM DBC.DBCInfo;",
"format":"OBJECT",
"includeColumns":True,
"rowLimit":20,

}

payload_json = json.dumps(payload)

response = requests.request("POST", url, headers=headers, data=payload_json, verify=False)

num_rows = response.json().get('results')[0].get('rowCount')
print("NUMBER of ROWS", num_rows)
print("==========================================================")

print(response.json())
----
Response
----
NUMBER of ROWS 20
==========================================================
{'queueDuration': 7, 'queryDuration': 227, 'results': [{'resultSet': True, 'columns': [{'name': 'DatabaseName', 'type': 'CHAR'}, {'name': 'USEDSPACE_IN_GB', 'type': 'FLOAT'}, {'name': 'MAXSPACE_IN_GB', 'type': 'FLOAT'}, {'name': 'Percentage_Used', 'type': 'FLOAT'}, {'name': 'REMAININGSPACE_IN_GB', 'type': 'FLOAT'}], 'data': [{'DatabaseName': 'DBC', 'USEDSPACE_IN_GB': 317.76382541656494, 'MAXSPACE_IN_GB': 1510.521079641879, 'Percentage_Used': 21.03670247964377, 'REMAININGSPACE_IN_GB': 1192.757254225314}, {'DatabaseName': 'EM', 'USEDSPACE_IN_GB': 0.0007491111755371094, 'MAXSPACE_IN_GB': 11.546071618795395, 'Percentage_Used': 0.006488017745513208, 'REMAININGSPACE_IN_GB': 11.545322507619858}, {'DatabaseName': 'user10', 'USEDSPACE_IN_GB': 0.019153594970703125, 'MAXSPACE_IN_GB': 9.313225746154785, 'Percentage_Used': 0.20566016, 'REMAININGSPACE_IN_GB': 9.294072151184082}, {'DatabaseName': 'EMEM', 'USEDSPACE_IN_GB': 0.006140708923339844, 'MAXSPACE_IN_GB': 4.656612873077393, 'Percentage_Used': 0.13187072, 'REMAININGSPACE_IN_GB': 4.650472164154053}, {'DatabaseName': 'EMWork', 'USEDSPACE_IN_GB': 0.0, 'MAXSPACE_IN_GB': 4.656612873077393, 'Percentage_Used': 0.0, 'REMAININGSPACE_IN_GB': 4.656612873077393}, {'DatabaseName': 'EMJI', 'USEDSPACE_IN_GB': 0.0, 'MAXSPACE_IN_GB': 2.3283064365386963, 'Percentage_Used': 0.0, 'REMAININGSPACE_IN_GB': 2.3283064365386963}, {'DatabaseName': 'USER_NAME', 'USEDSPACE_IN_GB': 0.0, 'MAXSPACE_IN_GB': 2.0, 'Percentage_Used': 0.0, 'REMAININGSPACE_IN_GB': 2.0}, {'DatabaseName': 'readonly', 'USEDSPACE_IN_GB': 0.0, 'MAXSPACE_IN_GB': 0.9313225746154785, 'Percentage_Used': 0.0, 'REMAININGSPACE_IN_GB': 0.9313225746154785}, {'DatabaseName': 'aug12_db', 'USEDSPACE_IN_GB': 7.200241088867188e-05, 'MAXSPACE_IN_GB': 0.9313225746154785, 'Percentage_Used': 0.0077312, 'REMAININGSPACE_IN_GB': 0.9312505722045898}, {'DatabaseName': 'SystemFe', 'USEDSPACE_IN_GB': 0.00018024444580078125, 'MAXSPACE_IN_GB': 0.7450580596923828, 'Percentage_Used': 0.024192, 'REMAININGSPACE_IN_GB': 0.744877815246582}, {'DatabaseName': 'dbcmngr', 'USEDSPACE_IN_GB': 3.814697265625e-06, 'MAXSPACE_IN_GB': 0.09313225746154785, 'Percentage_Used': 0.004096, 'REMAININGSPACE_IN_GB': 0.09312844276428223}, {'DatabaseName': 'EMViews', 'USEDSPACE_IN_GB': 0.027594566345214844, 'MAXSPACE_IN_GB': 0.09313225746154785, 'Percentage_Used': 29.62944, 'REMAININGSPACE_IN_GB': 0.06553769111633301}, {'DatabaseName': 'tdwm', 'USEDSPACE_IN_GB': 0.0006732940673828125, 'MAXSPACE_IN_GB': 0.09313225746154785, 'Percentage_Used': 0.722944, 'REMAININGSPACE_IN_GB': 0.09245896339416504}, {'DatabaseName': 'Crashdumps', 'USEDSPACE_IN_GB': 0.0, 'MAXSPACE_IN_GB': 0.06984921544790268, 'Percentage_Used': 0.0, 'REMAININGSPACE_IN_GB': 0.06984921544790268}, {'DatabaseName': 'SYSLIB', 'USEDSPACE_IN_GB': 0.006252288818359375, 'MAXSPACE_IN_GB': 0.03725290298461914, 'Percentage_Used': 16.78336, 'REMAININGSPACE_IN_GB': 0.031000614166259766}, {'DatabaseName': 'SYSBAR', 'USEDSPACE_IN_GB': 4.76837158203125e-06, 'MAXSPACE_IN_GB': 0.03725290298461914, 'Percentage_Used': 0.0128, 'REMAININGSPACE_IN_GB': 0.03724813461303711}, {'DatabaseName': 'SYSUDTLIB', 'USEDSPACE_IN_GB': 0.00035381317138671875, 'MAXSPACE_IN_GB': 0.029802322387695312, 'Percentage_Used': 1.1872, 'REMAININGSPACE_IN_GB': 0.029448509216308594}, {'DatabaseName': 'External_AP', 'USEDSPACE_IN_GB': 0.0, 'MAXSPACE_IN_GB': 0.01862645149230957, 'Percentage_Used': 0.0, 'REMAININGSPACE_IN_GB': 0.01862645149230957}, {'DatabaseName': 'SysAdmin', 'USEDSPACE_IN_GB': 0.002307891845703125, 'MAXSPACE_IN_GB': 0.01862645149230957, 'Percentage_Used': 12.3904, 'REMAININGSPACE_IN_GB': 0.016318559646606445}, {'DatabaseName': 'KZXaDtQp', 'USEDSPACE_IN_GB': 0.0, 'MAXSPACE_IN_GB': 0.009313225746154785, 'Percentage_Used': 0.0, 'REMAININGSPACE_IN_GB': 0.009313225746154785}], 'rowCount': 20, 'rowLimitExceeded': True}]}
----
==== Run Query - Using parametrized statements
----
# parameterize a query

url = "https://sdl57120:1443/systems/testsystem/queries"

payload = {
"query":"insert into metas_001.test values (?, ?, ?);", # get an insert query.
"format":"OBJECT",
"params":[['emp05', '01abc03', 'technology'], ['emp06', '01abc04', 'technology']] # array of array representing rows to be entered

}

payload_json = json.dumps(payload)

response = requests.request("POST", url, headers=headers, data=payload_json, verify=False)

print(response.text)
print(response.status_code)
----
Response
----
{"queueDuration":4,"queryDuration":21,"results":[{"resultSet":false,"count":1},{"resultSet":false,"count":1}]}
200
----
==== Advaned Features : Using Explicit Sessions and Async Queries
Do not confuse 'sessions' with Database sessions. Explicit sessions are meant to serialize queries (i.e, in transcations). An internal queue recieves the query in order and submits to the database.
Serialization is not guaranteed. Network conditions may cause queries to be recieved 'out' of order.
Explilcit sessions can be deleted by the client

==== Create a Session
----
# first create a session
url = "https://sdl57120:1443/systems/testsystem/sessions"

payload = {
  "auto_commit": True
}

payload_json = json.dumps(payload)

response = requests.request("POST", url, headers=headers, data=payload_json, verify=False)

print(response.text)
----
Response
----
{
  "sessionId" : 1366010,
  "system" : "testsystem",
  "user" : "dbc",
  "tdSessionNo" : 1626922,
  "createMode" : "EXPLICIT",
  "state" : "LOGGINGON",
  "autoCommit" : true
}
----

==== Use the session created above to submit queries

----
# use this session to submit queries afterwards

url = "https://sdl57120:1443/systems/testsystem/queries"

payload = {

"query":"SELECT * FROM DBC.DBCInfo;",
"format":"OBJECT",
"session" : 1366010 # <-- sessions

}
payload_json = json.dumps(payload)

response = requests.request("POST", url, headers=headers, data=payload_json, verify=False)

print(response.text)
----
Response
----
{"queueDuration":6,"queryDuration":41,"results":[{"resultSet":true,"data":[{"InfoKey":"LANGUAGE SUPPORT MODE","InfoData":"Standard"},{"InfoKey":"RELEASE","InfoData":"15.10.07.02"},{"InfoKey":"VERSION","InfoData":"15.10.07.02"}],"rowCount":3,"rowLimitExceeded":false}]}
----

==== Using Async Queries
----
## Run async query .

url = "https://sdl57120:1443/systems/testsystem/queries"

payload = {

"query":"SELECT * FROM DBC.DBCInfo;",
"format":"OBJECT",
"spooled_result_set" : True

}

payload_json = json.dumps(payload)
response = requests.request("POST", url, headers=headers, data=payload_json, verify=False)

print(response.text)
----
Response
----
{"id":1366025}
----

==== Response for async query
----
## response for async query .

url = "https://sdl57120:1443/systems/testsystem/queries/1366025"


payload_json = json.dumps(payload)
response = requests.request("GET", url, headers=headers, verify=False)

print(response.text)
----
Response
----
{"queryId":1366025,"query":"SELECT * FROM DBC.DBCInfo;","batch":false,"system":"testsystem","user":"dbc","session":1366015,"queryState":"RESULT_SET_READY","queueOrder":0,"queueDuration":6,"queryDuration":9,"statusCode":200,"resultSets":{},"counts":{},"exceptions":{},"outParams":{}}
----
==== Resultset for async query
----
url = "https://sdl57120:1443/systems/testsystem/queries/1366025/results"

payload_json = json.dumps(payload)
response = requests.request("GET", url, headers=headers, verify=False)

print(response.text)
----
Response
----
{"queueDuration":6,"queryDuration":9,"results":[{"resultSet":true,"data":[{"InfoKey":"LANGUAGE SUPPORT MODE","InfoData":"Standard"},{"InfoKey":"RELEASE","InfoData":"15.10.07.02"},{"InfoKey":"VERSION","InfoData":"15.10.07.02"}],"rowCount":3,"rowLimitExceeded":false}]}
----
==== User management
===== User that is not set up in the database or incorrect logins
----
url = "https://sdl61071:1443/systems/BasicTestSys/queries"

payload = {
"query":"SELECT * FROM DBC.DBCInfo;",
"format":"OBJECT", "includeColumns":True,

}

payload_json = json.dumps(payload)

headers_non_existing_user = {
'Authorization': 'Basic YWJjOmFiYw==', ## abc:dbc
'Content-Type': 'application/json'
}

response = requests.request("POST", url, headers=headers_non_existing_user, data=payload_json, verify=False)

print(response)
print(response.text)
----
Response
----
<Response [420]>
{
  "message" : "Invalid Credentials"
}
----
===== User that is not set up in the database or incorrect logins. lets use an existing user 'readonly' with password =dbc
----
url = "https://sdl57120:1443/systems/testsystem/queries"

"""
payload = {
"query":"SELECT * FROM DBC.DBCInfo;",
"format":"OBJECT", "includeColumns":True,

}
"""
payload = {
"query":"insert into metas_001.test values (?, ?, ?);", # get an insert query.
"format":"OBJECT",
"params":[['emp05', '01abc05', 'technology'], ['emp05', '01abc05', 'technology']] # array of array representing rows to be entered

}

payload_json = json.dumps(payload)

# change the header to reflect this user. User does not have INSERT access to object metas_001.test

headers_readonly_user = {
  'Authorization': 'Basic cmVhZG9ubHk6ZGJj', ## readonly:dbc
  'Content-Type': 'application/json'
}

response = requests.request("POST", url, headers=headers_readonly_user, data=payload_json, verify=False)

print(response)
print(response.text)
----
Response
----
<Response [420]>
{
  "error" : "3523",
  "message" : "The user does not have INSERT access to metas_001.test."
}
----
==== Get a list of queries
----
## get queries (shows queries that are running )

url = "https://sdl61071:1443/systems/BasicTestSys/queries"

payload={}

response = requests.request("GET", url, headers=headers, data=payload, verify=False)

print(response.json())
----
Response
----
[
{
"queryId": 12516087,
"query": "SELECt * from dbcmgr.AlertRequest;",
"batch": false,
"system": "BasicTestSys",
"user": "dbc",
"session": 12516011,
"queryState": "REST_SET_READY",
"queueOrder": 0,
"queueDurayion": 3,
"queryDuration": 3,
"statusCode": 200,
"resultSets": {},
"counts": {},
"exceptions": {},
"outparams": {}
},
{
"queryId": 12516088,
"query": "SELECt * from dbc.DBQLAmpDataTbl;",
"batch": false,
"system": "BasicTestSys",
"user": "dbc",
"session": 12516011,
"queryState": "REST_SET_READY",
"queueOrder": 0,
"queueDurayion": 3,
"queryDuration": 3,
"statusCode": 200,
"resultSets": {},
"counts": {},
"exceptions": {},
"outparams": {}
}
]
----

== Next Steps
You have now successfully completed the basic tasks required to use Query Service.
You can now do

== Resources
Refer to the link:https://docs.teradata.com/r/Teradata-Query-Service-Installation-Configuration-and-Usage-Guide-for-Customers/April-2022[Query Service Installation, Configuration, and Usage Guide]
 to explore the full potential of Query Service, and experiment with examples.
