= ModelOps - Import and Deploy your first BYOM Model
:experimental:
:page-author: Pablo Escobar de la Oliva
:page-email: pablo.escobardelaoliva@teradata.com
:page-revdate: October 5th, 2022
:description: Tutorial for deploying and monitor a PMML model into Vantage using ModelOps
:keywords: modelops, clearscape analytics, teradata, data warehouses, teradata, vantage, cloud data platform, machine learning, artificial intelligence, business intelligence, enterprise analytics

== Overview

This is a quickstart tutorial for anyone new to Vantage ModelOps that starts from scratch. In the tutorial, you will be able to create a new project in ModelOps, upload needed data to Vantage and track the full lifecycle of an imported Diabetes demo model using BYOM mechanisms.

== Prerequisites

You need access to a Teradata Vantage instance with ClearScape Analytics (ModelOps), and a Jupyter notebook tool

include::ROOT:partial$vantage.express.options.adoc[]

Files needed

Let's start by downloading the needed files for this tutorial. Download these 4 attachments and upload them in your Notebook filesystem. 

link:{attachmentsdir}/ModelOps_Training.ipynb[Download the ModelOps training Notebook]

link:{attachmentsdir}/BYOM.ipynb[Download BYOM Notebook file for demo use case]

link:{attachmentsdir}/ModelOps_Data_files.zip[Download data files for demo use case]

link:{attachmentsdir}/ModelOps_BYOM_files.zip[Download BYOM code files for demo use case]

Alternatively you can git clone following repos
[source, cli]
----
git clone https://github.com/willfleury/modelops-getting-started
git clone https://github.com/Teradata/modelops-demo-models/
----

Setting up the Database and Jupyter environment 

Follow the ModelOps_Training Jupyter Notebook to setup the database, tables and libraries needed for the demo.

== Understand where we are in the Methodology

image::BYOM.png[ModelOps Methodlogy BYOM screenshot, width=100%]



== Create a new Project or use existing

Add Project

* create project

* Details

* Name: Demo: your-name

* Description: ModelOps Demo

* Group: your-name

* Path: https://github.com/Teradata/modelops-demo-models

* Credentials: No Credentials

* Branch: master

Here you can test the git connection, If is green then save and continue. For the Service connection you can skip for now. 

When Creating a new Project, ModelOps will ask you for a new connection. 

== Create a Personal Connection

Personal Connection

* Name: Vantage Personal your-name

* Description: Vantage Demo Env

* Host: 3.238.151.85 (internal for teradata transcend)

* Database: your-db

* Login Mech: TDNEGO

* Username/Password

== Add Dataset to identify Vantage Tables for BYOM evaluation and scoring

Let's create a new Dataset Template, then 1 Dataset for Training and 2 Datasets for Evaluation so we can monitor model quality metrics with 2 different datasets

Add Datasets

* create dataset template

* Catalog

* Name: PIMA

* Description: PIMA Diabetes

* Feature Catalog: Vantage

* Database: your-db

* Table: aoa_feature_metadata

Features
Query:
[source, teradata-sql]
----
SELECT * FROM {your-db}.pima_patient_features
----
Entity Key: PatientId
Features: NumTimesPrg, PlGlcConc, BloodP, SkinThick, TwoHourSerIns, BMI, DiPedFunc, Age

Entity & Target
Query: 
[source, teradata-sql]
----
SELECT * FROM {your-db}.pima_patient_diagnoses
----
Entity Key: PatientId
Target: HasDiabetes

Predictions

* Database: your-db

* Table: pima_patient_predictions

Entity Selection: 

Query: 
[source, teradata-sql]
----
SELECT * FROM pima_patient_features WHERE patientid MOD 5 = 0
----
BYOM Target Column: CAST(CAST(json_report AS JSON).JSONExtractValue('$.predicted_HasDiabetes') AS INT)

== Create training dataset

Basic

* Name: Train

* Description: Training dataset

* Scope: Training

* Entity & Target

Query: 
[source, teradata-sql]
----
SELECT * FROM {your-db}.pima_patient_diagnoses WHERE patientid MOD 5 = 1
----

== Create evaluation dataset 1

Basic

* Name: Evaluate

* Description: Evaluation dataset

* Scope: Evaluation

* Entity & Target

Query: 
[source, teradata-sql]
----
SELECT * FROM {your-db}.pima_patient_diagnoses WHERE patientid MOD 5 = 2
----


== Create evaluation dataset 2

Basic

* Name: Evaluate

* Description: Evaluation dataset

* Scope: Evaluation

* Entity & Target

Query: 
[source, teradata-sql]
----
SELECT * FROM {your-db}.pima_patient_diagnoses WHERE patientid MOD 5 = 3
----


== Validate Permissions in SQL database for VAL and BYOM

VAL
[source, teradata-sql]
----
GRANT EXECUTE PROCEDURE ON { val-db }.td_analyze TO { username | rolename };
GRANT EXECUTE FUNCTION ON { val-db }.tda_dt_calc TO { username | rolename };
GRANT EXECUTE FUNCTION ON { val-db }.tda_kmeans TO { username | rolename };
----

BYOM
[source, teradata-sql]
----
GRANT EXECUTE FUNCTION on { mldb } to { username | rolename };
GRANT EXECUTE FUNCTION ON { mldb } TO { database } WITH GRANT OPTION;
----

Alternatively you can check the permissions with the new Healthcheck panel in the connections panel

image::ModelOps_Healthcheck.png[ModelOps Healtcheck screenshot, width=500]


== Model Lifecycle for a new BYOM

Download and unzip the files needed, links are at the top of the tutorial. For PMML file you can also download a PMML generated in the training of a GIT model.

* BYOM.ipynb

* model.pmml 

* requirements.txt

* evaluation.py 

* data_stats.json

* __init__.py

Define BYOM Model with Evaluation and Monitoring

* Import Version

* Evaluate

* Review evaluation report, including dataset statistics

* Approve

* Deploy in Vantage - Engine, Publish, Schedule. Scoring dataset is required
Use your connection and select a database. e.g "aoa_byom_models"

* Deployments/executions

* Evaluate again with dataset2 - to monitor model metrics behavior

* Monitor Model Drift - Data and Metrics

* Open BYOM notebook to execute the PMML predict from SQL code 

* Retire


== Summary

In this quick start we have learned how to import a PMML model into ModelOps and how to deploy it into Vantage, where we will scheduling a batch scoring and start monitoring on Data Drift and Model Quality metrics.

== Further reading
* link:https://docs.teradata.com/r/Teradata-VantageTM-ModelOps-User-Guide[Teradata Vantageâ„¢ - ModelOps User Guide - Login required at this moment]
